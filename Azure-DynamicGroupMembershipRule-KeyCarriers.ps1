Import-Module AzureADPreview

$keyCarrierGroups = @()
$storeInfo = @{}

$keyCarrierGroups = (Get-ADGroup -Filter {DisplayName -like "*_Key_Carriers"})
$DynamicGroupSet = foreach ($group in $keyCarrierGroups){Get-AzureADMSGroup -Id $group.Name.Split("_")[1]}
foreach($group in $DynamicGroupSet){$storeInfo.add($group.DisplayName.Split("_")[0],$group.Id)}
foreach($store in $storeinfo.Keys){
#$membershipRule = '(user.Department -contains '+'"'+$store.ToString()+'"'+') -and (user.extensionAttribute3 -eq "A") -and (user.extensionAttribute6 -contains "10005") -or (user.extensionAttribute6 -contains "10006") -or (user.extensionAttribute6 -contains "10013") -or (user.extensionAttribute6 -contains "10064") -or (user.extensionAttribute6 -contains "10070") -or (user.extensionAttribute6 -contains "10078") -or (user.extensionAttribute6 -contains "10146") -or (user.extensionAttribute6 -contains "205") -or (user.extensionAttribute6 -contains "10158") -or (user.extensionAttribute6 -contains "10173") -or (user.extensionAttribute6 -contains "40057") -or (user.extensionAttribute6 -contains "10012") -or (user.extensionAttribute6 -contains "10022") -or (user.extensionAttribute6 -contains "10023") -or (user.extensionAttribute6 -contains "10104") -or (user.extensionAttribute6 -contains "10123") -or (user.extensionAttribute6 -contains "70017") -or (user.extensionAttribute6 -contains "70029") -or (user.extensionAttribute6 -contains "70056") -or (user.extensionAttribute6 -contains "70099") -or (user.extensionAttribute6 -contains "80004") -or (user.extensionAttribute6 -contains "80016") -or (user.extensionAttribute6 -contains "80076") -or (user.extensionAttribute6 -contains "80143") -or (user.extensionAttribute6 -contains "80156") -or (user.extensionAttribute6 -contains "10166") -or (user.extensionAttribute6 -contains "10179") -or (user.extensionAttribute6 -contains "80178") -or (user.extensionAttribute6 -contains "80217") -or (user.extensionAttribute6 -contains "80224") -or (user.extensionAttribute6 -contains "10010") -or (user.extensionAttribute6 -contains "80003") -or (user.extensionAttribute6 -contains "80011") -or (user.extensionAttribute6 -contains "80014") -or (user.extensionAttribute6 -contains "80066") -or (user.extensionAttribute6 -contains "80090") -or (user.extensionAttribute6 -contains "10136") -or (user.extensionAttribute6 -contains "10159") -or (user.extensionAttribute6 -contains "10181") -or (user.extensionAttribute6 -contains "10183") -or (user.extensionAttribute6 -contains "10185") -or (user.extensionAttribute6 -contains "70128") -or (user.extensionAttribute6 -contains "80177") -or (user.extensionAttribute6 -contains "80191")'
$membershipRule = '(user.Department -contains '+'"'+$store.ToString()+'"'+') -and (user.extensionAttribute3 -eq "A") -and ((user.extensionAttribute13 -In ["10005","10010","10012","10013","10023","70099","80003","80004"]) -or (user.extensionAttribute6 -contains "10005") -or (user.extensionAttribute6 -contains "10010") -or (user.extensionAttribute6 -contains "10012") -or (user.extensionAttribute6 -contains "10013") -or (user.extensionAttribute6 -contains "10023") -or (user.extensionAttribute6 -contains "70099") -or (user.extensionAttribute6 -contains "80003") -or (user.extensionAttribute6 -contains "80004"))'
Set-AzureADMSGroup -Id ($storeinfo.Item($store)) -MembershipRule $membershipRule
}
